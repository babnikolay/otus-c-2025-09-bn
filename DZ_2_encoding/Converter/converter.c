#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#define ROWS 162
#define COLS 5

/*
Примерный массив соответствия CP1251, KOI8-R, ISO8859-5 -> UTF-8 
Столбцы 0 и 1 относятся к UTF-8
Столбец 2 к CP1251
Столбец 3 к KOI8-R
Столбец 4 к ISO8859-5
*/
unsigned char encoding_to_utf8[ROWS][COLS] = {
    // Заполняем только нужные символы для упрощения
    {0x20, 0, 0x20, 0x20, 0x20},  // пробел
    {0x21, 0, 0x21, 0x21, 0x21},  // '!'
    {0x22, 0, 0x22, 0x22, 0x22},
    {0x23, 0, 0x23, 0x23, 0x23},
    {0x24, 0, 0x24, 0x24, 0x24},
    {0x25, 0, 0x25, 0x25, 0x25},
    {0x26, 0, 0x26, 0x26, 0x26},
    {0x27, 0, 0x27, 0x27, 0x27},
    {0x28, 0, 0x28, 0x28, 0x28},
    {0x29, 0, 0x29, 0x29, 0x29},
    {0x2A, 0, 0x2A, 0x2A, 0x2A},
    {0x2A, 0, 0x2A, 0x2A, 0x2A},
    {0x2C, 0, 0x2C, 0x2C, 0x2C},
    {0x2D, 0, 0x2D, 0x2D, 0x2D},
    {0x2E, 0, 0x2E, 0x2E, 0x2E},
    {0x2F, 0, 0x2F, 0x2F, 0x2F},
    {0x30, 0, 0x30, 0x30, 0x30},    // 0
    {0x31, 0, 0x31, 0x31, 0x31},    // 1
    {0x32, 0, 0x32, 0x32, 0x32},
    {0x33, 0, 0x33, 0x33, 0x33},
    {0x34, 0, 0x34, 0x34, 0x34},
    {0x35, 0, 0x35, 0x35, 0x35},
    {0x36, 0, 0x36, 0x36, 0x36},
    {0x37, 0, 0x37, 0x37, 0x37},
    {0x38, 0, 0x38, 0x38, 0x38},
    {0x39, 0, 0x39, 0x39, 0x39},    // 9
    {0x3A, 0, 0x3A, 0x3A, 0x3A},
    {0x3B, 0, 0x3B, 0x3B, 0x3B},
    {0x3C, 0, 0x3C, 0x3C, 0x3C},
    {0x3D, 0, 0x3D, 0x3D, 0x3D},
    {0x3E, 0, 0x3E, 0x3E, 0x3E},
    {0x3F, 0, 0x3F, 0x3F, 0x3F},
    {0x40, 0, 0x40, 0x40, 0x40},
    {0x41, 0, 0x41, 0x41, 0x41},    // 'A'
    {0x42, 0, 0x42, 0x42, 0x42},    // 'B'
    {0x43, 0, 0x43, 0x43, 0x43},
    {0x44, 0, 0x44, 0x44, 0x44},
    {0x45, 0, 0x45, 0x45, 0x45},
    {0x46, 0, 0x46, 0x46, 0x46},
    {0x47, 0, 0x47, 0x47, 0x47},
    {0x48, 0, 0x48, 0x48, 0x48},
    {0x49, 0, 0x49, 0x49, 0x49},
    {0x4A, 0, 0x4A, 0x4A, 0x4A},
    {0x4B, 0, 0x4B, 0x4B, 0x4B},
    {0x4C, 0, 0x4C, 0x4C, 0x4C},
    {0x4D, 0, 0x4D, 0x4D, 0x4D},
    {0x4E, 0, 0x4E, 0x4E, 0x4E},
    {0x4F, 0, 0x4F, 0x4F, 0x4F},
    {0x50, 0, 0x50, 0x50, 0x50},
    {0x51, 0, 0x51, 0x51, 0x51},
    {0x52, 0, 0x52, 0x52, 0x52},
    {0x53, 0, 0x53, 0x53, 0x53},
    {0x54, 0, 0x54, 0x54, 0x54},
    {0x55, 0, 0x55, 0x55, 0x55},
    {0x56, 0, 0x56, 0x56, 0x56},
    {0x57, 0, 0x57, 0x57, 0x57},
    {0x58, 0, 0x58, 0x57, 0x57},
    {0x59, 0, 0x59, 0x59, 0x59},
    {0x5A, 0, 0x5A, 0x5A, 0x5A},    // 'Z'
    {0x5B, 0, 0x5B, 0x5B, 0x5B},
    {0x5C, 0, 0x5C, 0x5C, 0x5C},
    {0x5D, 0, 0x5D, 0x5D, 0x5D},
    {0x5E, 0, 0x5E, 0x5E, 0x5E},
    {0x5F, 0, 0x5F, 0x5F, 0x5F},
    {0x60, 0, 0x60, 0x60, 0x60},
    {0x61, 0, 0x61, 0x61, 0x61},    // 'a'
    {0x62, 0, 0x62, 0x62, 0x62},    // 'b'
    {0x63, 0, 0x63, 0x63, 0x63},
    {0x64, 0, 0x64, 0x64, 0x64},
    {0x65, 0, 0x65, 0x65, 0x65},
    {0x66, 0, 0x66, 0x66, 0x66},
    {0x67, 0, 0x67, 0x67, 0x67},
    {0x68, 0, 0x68, 0x68, 0x68},
    {0x69, 0, 0x69, 0x69, 0x69},
    {0x6A, 0, 0x6A, 0x6A, 0x6A},
    {0x6B, 0, 0x6B, 0x6B, 0x6B},
    {0x6C, 0, 0x6C, 0x6C, 0x6C},
    {0x6D, 0, 0x6D, 0x6D, 0x6D},
    {0x6E, 0, 0x6E, 0x6E, 0x6E},
    {0x6F, 0, 0x6F, 0x6F, 0x6F},
    {0x70, 0, 0x70, 0x70, 0x70},
    {0x71, 0, 0x71, 0x71, 0x71},
    {0x72, 0, 0x72, 0x72, 0x72},
    {0x73, 0, 0x73, 0x73, 0x73},
    {0x74, 0, 0x74, 0x74, 0x74},
    {0x75, 0, 0x75, 0x75, 0x75},
    {0x76, 0, 0x76, 0x76, 0x76},
    {0x77, 0, 0x77, 0x77, 0x77},
    {0x78, 0, 0x78, 0x78, 0x78},
    {0x79, 0, 0x79, 0x79, 0x79},
    {0x7A, 0, 0x7A, 0x7A, 0x7A},    // 'z'
    {0x7B, 0, 0x7B, 0x7B, 0x7B},
    {0x7C, 0, 0x7C, 0x7C, 0x7C},
    {0x7D, 0, 0x7D, 0x7D, 0x7D},
    {0x7E, 0, 0x7E, 0x7E, 0x7E},
    {0x7F, 0, 0x7F, 0x7F, 0x7F},
    {0xD0, 0x81, 0xA8, 0xB3, 0xB3},  // 'Ё'
    {0xD0, 0x90, 0xC0, 0xE1, 0xB0},  // 'А'
    {0xD0, 0x91, 0xC1, 0xE2, 0xB1},  // 'Б'
    {0xD0, 0x92, 0xC2, 0xF7, 0xB2},  // 'В'
    {0xD0, 0x93, 0xC3, 0xE7, 0xB3},  // 'Г'
    {0xD0, 0x94, 0xC4, 0xE4, 0xB4},  // 'Д'
    {0xD0, 0x95, 0xC5, 0xE5, 0xB5},  // 'Е'
    {0xD0, 0x96, 0xC6, 0xF6, 0xB6},  // 'Ж'
    {0xD0, 0x97, 0xC7, 0xFA, 0xB7},  // 'З'
    {0xD0, 0x98, 0xC8, 0xE9, 0xB8},  // 'И'
    {0xD0, 0x99, 0xC9, 0xEA, 0xB9},  // 'Й'
    {0xD0, 0x9A, 0xCA, 0xEB, 0xBA},  // 'К'
    {0xD0, 0x9B, 0xCB, 0xEC, 0xBB},  // 'Л'
    {0xD0, 0x9C, 0xCC, 0xED, 0xBC},  // 'М'
    {0xD0, 0x9D, 0xCD, 0xEE, 0xBD},  // 'Н'
    {0xD0, 0x9E, 0xCE, 0xEF, 0xBE},  // 'О'
    {0xD0, 0x9F, 0xCF, 0xF0, 0xBF},  // 'П'
    {0xD0, 0xA0, 0xD0, 0xF2, 0xC0},  // 'Р'
    {0xD0, 0xA1, 0xD1, 0xF3, 0xC1},  // 'С'
    {0xD0, 0xA2, 0xD2, 0xF4, 0xC2},  // 'Т'
    {0xD0, 0xA3, 0xD3, 0xF5, 0xC3},  // 'У'
    {0xD0, 0xA4, 0xD4, 0xE6, 0xC4},  // 'Ф'
    {0xD0, 0xA5, 0xD5, 0xE8, 0xC5},  // 'Х'
    {0xD0, 0xA6, 0xD6, 0xE3, 0xC6},  // 'Ц'
    {0xD0, 0xA7, 0xD7, 0xFE, 0xC7},  // 'Ч'
    {0xD0, 0xA8, 0xD8, 0xFB, 0xC8},  // 'Ш'
    {0xD0, 0xA9, 0xD9, 0xFD, 0xC9},  // 'Щ'
    {0xD0, 0xAA, 0xDA, 0xFF, 0xCA},  // 'Ъ'
    {0xD0, 0xAB, 0xDB, 0xF9, 0xCB},  // 'Ы'
    {0xD0, 0xAC, 0xDC, 0xF8, 0xCC},  // 'Ь'
    {0xD0, 0xAD, 0xDD, 0xFC, 0xCD},  // 'Э'
    {0xD0, 0xAE, 0xDE, 0xE0, 0xCE},  // 'Ю'
    {0xD0, 0xAF, 0xDF, 0xF1, 0xCF},  // 'Я'
    {0xD1, 0x91, 0xB8, 0xA3, 0xA3},  // 'ё'
    {0xD1, 0xB0, 0xE0, 0xC1, 0xD0},  // 'а'
    {0xD1, 0xB1, 0xE1, 0xC2, 0xD1},  // 'б'
    {0xD1, 0xB2, 0xE2, 0xD7, 0xD2},  // 'в'
    {0xD1, 0xB3, 0xE3, 0xC7, 0xD3},  // 'г'
    {0xD1, 0xB4, 0xE4, 0xC4, 0xD4},  // 'д
    {0xD1, 0xB5, 0xE5, 0xC5, 0xD5},  // 'е'
    {0xD1, 0xB6, 0xE6, 0xD6, 0xD6},  // 'ж'
    {0xD1, 0xB7, 0xE7, 0xDA, 0xD7},  // 'з'
    {0xD1, 0xB8, 0xE8, 0xC9, 0xD8},  // 'и'
    {0xD1, 0xB9, 0xE9, 0xCA, 0xD9},  // 'й'
    {0xD1, 0xBA, 0xEA, 0xCB, 0xDA},  // 'к'
    {0xD1, 0xBB, 0xEB, 0xCC, 0xDB},  // 'л'
    {0xD1, 0xBC, 0xEC, 0xCD, 0xDC},  // 'м'
    {0xD1, 0xBD, 0xED, 0xCE, 0xDD},  // 'н'
    {0xD1, 0xBE, 0xEE, 0xCF, 0xDE},  // 'о'
    {0xD1, 0xBF, 0xEF, 0xD0, 0xDF},  // 'п'
    {0xD1, 0x80, 0xF0, 0xD2, 0xE0},  // 'р'
    {0xD1, 0x81, 0xF1, 0xD3, 0xE1},  // 'с'
    {0xD1, 0x82, 0xF2, 0xD4, 0xE2},  // 'т'
    {0xD1, 0x83, 0xF3, 0xD5, 0xE3},  // 'у'
    {0xD1, 0x84, 0xF4, 0xC6, 0xE4},  // 'ф'
    {0xD1, 0x85, 0xF5, 0xC8, 0xE5},  // 'х'
    {0xD1, 0x86, 0xF6, 0xC3, 0xE6},  // 'ц'
    {0xD1, 0x87, 0xF7, 0xDE, 0xE7},  // 'ч'
    {0xD1, 0x88, 0xF8, 0xDB, 0xE8},  // 'ш'
    {0xD1, 0x89, 0xF9, 0xCD, 0xE9},  // 'щ'
    {0xD1, 0x8A, 0xFA, 0xDF, 0xEA},  // 'ъ'
    {0xD1, 0x8B, 0xFB, 0xD9, 0xEB},  // 'ы'
    {0xD1, 0x8C, 0xFC, 0xD8, 0xEC},  // 'ь'
    {0xD1, 0x8D, 0xFD, 0xDC, 0xED},  // 'э'
    {0xD1, 0x8E, 0xFE, 0xC0, 0xEE},  // 'ю'
    {0xD1, 0x8F, 0xFF, 0xD1, 0xEF}   // 'я'
};

enum enc_t { ENC_UNKNOWN = -1, ENC_CP1251 = 2, ENC_KOI8R, ENC_ISO8859_5 };

static enum enc_t detect_enc(const char *s) {
    if (strcmp(s, "cp1251") == 0 || strcmp(s, "CP1251") == 0 || strcmp(s, "windows-1251") || strcmp(s, "Windows-1251") == 0)
        return ENC_CP1251;
    if (strcmp(s, "koi8-r") == 0 || strcmp(s, "KOI8-R") == 0 || strcmp(s, "koi8r") == 0 || strcmp(s, "KOI8R") == 0)
        return ENC_KOI8R;
    if (strcmp(s, "iso-8859-5") == 0 || strcmp(s, "iso8859-5") == 0 || strcmp(s, "ISO8859-5") == 0 || strcmp(s, "ISO-8859-5") == 0)
        return ENC_ISO8859_5;
    return ENC_UNKNOWN; // Вернуть неизвестную кодировку
}

int find_element_index(unsigned char arr[ROWS][COLS], enum enc_t encoding, unsigned char target) {
    for (int i = 0; i < ROWS; i++) {
        if (arr[i][encoding] == target) {
            // printf("Элемент 0x%x - %c найден на индексе [%d]\n", target, target, i);
            return i; // Выходим из функции, если нашли элемент
        }
    }

    return 0;
}

void converting_to_utf8(FILE *input, enum enc_t encoding, FILE *output) {
    int file_len = 0;
    while (!feof(input)) {
        getc(input);
        // char ch = getc(input);
        // printf("%c", ch);
        file_len++;
    }
    printf("\nДлина файла: %d\n", file_len);

    long int file_pos;
    if((file_pos=ftell(input)) == -1L) {
        perror("Ошибка получения позиции в файле");
    }
    printf("Позиция в файле %ld\n", file_pos);
    fseek(input, 0, SEEK_SET);

    unsigned char buffer[file_len];
    while (fread(buffer, sizeof(unsigned char), file_len, input) > 0) {
        for (int i = 0; i < file_len; i++) {
            unsigned char target = buffer[i];
            int index = 0;
            index = find_element_index(encoding_to_utf8, encoding, target);
            // printf("Элемент 0x%x - %c найден на индексе [%d] в тексте\n", target, target, i);
            if (target >= 128) {
                fputc(encoding_to_utf8[index][0], output);
                fputc(encoding_to_utf8[index][1], output);
            } else {
                fputc(target, output);
            }

            if(i == (file_len-1)) {
                fputc(0xD, output);
            }
        }
    }
}

void display_usage() {
    printf("Использование: convert <входной файл> <кодировка> <выходной файл>\n");
    printf("Кодировки: cp1251, koi8r, iso8859-5\n");
    printf("Варианты набора: Windows-1251, windows-1251, CP1251, cp1251\n");
    printf("Варианты набора: KOI8-R, koi8-r, KOI8R, koi8r\n");
    printf("Варианты набора: ISO-8859-5, iso-8859-5, ISO8859-5, iso8859-5\n");
}

int main(int argc, char *argv[]) {

    if (argc != 4) {
        display_usage();
        return EXIT_FAILURE;
    }

    FILE *fin = fopen(argv[1], "r");
    if (fin == NULL) {
        perror("Ошибка открытия входного файла");
        return EXIT_FAILURE;
    }

    FILE *fout = fopen(argv[3], "w");
    if (fout == NULL) {
        perror("Ошибка открытия выходного файла");
        return EXIT_FAILURE;
    }

    enum enc_t enc = detect_enc(argv[2]);
    fprintf(stdout, "Кодировка: %s - %d\n", argv[2], enc);

    switch (enc) {
    case ENC_CP1251:
        converting_to_utf8(fin, enc, fout);
        break;
    case ENC_KOI8R:
        converting_to_utf8(fin, enc, fout);
        break;
    case ENC_ISO8859_5:
        converting_to_utf8(fin, enc, fout);
        break;
    default:
        fprintf(stderr, "Неизвестная кодировка: %d\n", enc);
        return EXIT_FAILURE;
    }

    if (fclose(fin) != 0) {
        fprintf(stderr, "Ошибка закрытия входного файла: %s\n", strerror(errno));
    }

    if (fclose(fout) != 0) {
        fprintf(stderr, "Ошибка закрытия выходного файла: %s\n", strerror(errno));
    }

    return EXIT_SUCCESS;
}
